name: CI/CD WordPress to AWS

on:
  push:
    branches:
      - main

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: "590183684211"
  ECR_REPO: "wordpress-cicd"
  IMAGE_TAG: "latest"

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # =======================
      #   TRIVY INSTALLATION
      # =======================
      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install wget -y
          wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.50.0_Linux-64bit.deb
          sudo dpkg -i trivy_0.50.0_Linux-64bit.deb

      # =======================
      #  TRIVY VULN SCAN
      # =======================
      - name: Trivy Vulnerability Scan (HIGH + CRITICAL)
        run: |
          trivy fs --severity HIGH,CRITICAL --exit-code 0 .

      # =======================
      #  AWS LOGIN ECR
      # =======================
      - name: Login to Amazon ECR (using EC2 role)
        run: |
          aws ecr get-login-password --region $AWS_REGION \
          | docker login --username AWS --password-stdin \
          $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com

      # =======================
      #  DOCKER BUILD
      # =======================
      - name: Build Docker image
        run: |
          docker build -t $ECR_REPO:$IMAGE_TAG .

      # =======================
      #  TAG DOCKER IMAGE
      # =======================
      - name: Tag Docker image
        run: |
          ECR_URI=$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO
          docker tag $ECR_REPO:$IMAGE_TAG $ECR_URI:$IMAGE_TAG
          echo "ECR_URI=$ECR_URI" >> $GITHUB_ENV

      # =======================
      #  PUSH IMAGE TO ECR
      # =======================
      - name: Push Docker image to ECR
        run: |
          docker push $ECR_URI:$IMAGE_TAG

      # =======================
      #  DEPLOY WORDPRESS + MYSQL
      # =======================
      - name: Deploy WordPress + MySQL on EC2
        run: |
          ECR_URI=$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO

          # Crear red si no existe
          if ! docker network ls --format '{{.Name}}' | grep -q '^wp-net$'; then
            docker network create wp-net
          fi

          # Crear contenedor MySQL si no existe
          if ! docker ps -a --format '{{.Names}}' | grep -q '^wp-mysql$'; then
            docker run -d \
              --name wp-mysql \
              --network wp-net \
              -e MYSQL_DATABASE=wordpress \
              -e MYSQL_USER=wpuser \
              -e MYSQL_PASSWORD=wppassword \
              -e MYSQL_ROOT_PASSWORD=rootpassword \
              mysql:5.7
          fi

          # Borrar contenedor anterior de WordPress
          docker rm -f wp-app || true

          # Descargar nueva imagen desde ECR
          docker pull $ECR_URI:$IMAGE_TAG

          # Levantar WordPress
          docker run -d \
            --name wp-app \
            --network wp-net \
            -p 80:80 \
            -e WORDPRESS_DB_HOST=wp-mysql:3306 \
            -e WORDPRESS_DB_USER=wpuser \
            -e WORDPRESS_DB_PASSWORD=wppassword \
            -e WORDPRESS_DB_NAME=wordpress \
            $ECR_URI:$IMAGE_TAG
